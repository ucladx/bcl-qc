### Goal

Minimal infrastructure needed for secondary analysis and QC of data generated by Illumina sequencers in a clinical NGS lab.

### Strategy

For an NGS lab like ours with few engineers - the less infrastructure we build, the less we need to maintain, a lower chance of failure, and easier to debug. Our strategy is to outsource the most complex pieces of necessary infrastructure to mature commercial solutions with a large number of users with similar use-cases. More users ensure exhaustive bug reporting and pushes vendors to prioritize fixes and new features. At the same time, we don't want to invest in "end-to-end" solutions from vendors (e.g. [ICA](https://developer.illumina.com/news-updates/illumina-connected-analytics-productionize-your-informatics-workflows-at-scale) and [DDM](https://www.sophiagenetics.com/technology)), and must instead carefully modularize our infrastructure, so that we can replace each module with better alternatives in the future. Modular infrastructure also gives us some autonomy to solve issues ourselves without dependence on vendor tech support.

### Scope

- Given a [Dragen](https://www.illumina.com/products/by-type/informatics-products/dragen-secondary-analysis.html) server, monitor run output from sequencers and trigger secondary analyses.
- Generate and track run-level and sample-level QC metrics using [MultiQC](https://multiqc.info) and [MegaQC](https://megaqc.info).
- Orchestrate archival and retrieval of sequencing data in cheap cloud storage like [Azure Blobs](https://azure.microsoft.com/en-us/products/storage/blobs).

### Quick start

Clone this repo and optionally check out a specific version tag or development branch.

```bash
git clone git@github.com:ucladx/bcl-qc.git
cd bcl-qc
git checkout v1.1.0
```

Unless you already have it, install mamba and initialize it in your bash environment.

```bash
curl -L https://github.com/conda-forge/miniforge/releases/download/23.3.1-1/Mambaforge-Linux-x86_64.sh -o mambaforge.sh
sh mambaforge.sh -bfp $HOME/mambaforge && rm -f mambaforge.sh
$HOME/mambaforge/condabin/mamba init
```

Log out and login to ensure that the `mamba` and `conda` commands are added to your `$PATH`. Then install dependencies into a new conda environment.

```bash
mamba env create -n bclqc -f config/conda_env.yml
conda activate bclqc
```

Now we can trigger demux and alignment on a run output folder as follows.

```bash
```

### Demo data

If you don't have your own BCLs to test this on, you can download some demo data from Illumina. Visit [basespace.illumina.com](https://basespace.illumina.com) and login. Create an account if needed. Then visit [basespace.illumina.com/s/3IssYzrEJiwH](https://basespace.illumina.com/s/3IssYzrEJiwH) and click "Accept" to add the demo project to your BaseSpace account. We can now programmatically download it using the BaseSpace Command-Line Interface (CLI). The BaseSpace CLI cannot be installed using mamba, so download it manually and copy it into your conda environment.

```bash
curl -sL https://launch.basespace.illumina.com/CLI/latest/amd64-linux/bs -o $CONDA_PREFIX/bin/bs
chmod +x $CONDA_PREFIX/bin/bs
```

Run `bs auth` and follow the instructions to login to the CLI. Then download the BCLs from Illumina as follows:

```bash
mkdir data
bs download run --summary --id 191167079 --output data
```
